---
layout: post
title:  循环展开的好处
keywords: 高性能基础学习
categories : 高性能基础学习
tags:
  - 高性能基础学习
---
对程序进行并行优化时，经常使用的优化方法是：循环展开。那么，循环展开有哪些好处呢？




## 展开循环的好处如下：

由于展开能够消除分支以及一些管理归纳变量的代码，因此可以摊销一些分支开销。
展开可以积极调度（或管道化）循环以掩盖一些延迟。如果有足够的空闲寄存器使变量保持活动状态，因为通过展开相关性链展露了关键路径，这将非常有用。
如果迭代次数是可预测的，并且循环中没有条件分支，则英特尔(R) 奔腾(R) 4 处理器可以正确预测迭代次数为 16 次或更少的内部循环的退出分支。因此，如果循环体不是太大，并且已知可探测的迭代次数，则可以展开内部循环，直到它们的迭代次数达到最大值 16。对于奔腾 III 或奔腾 II 处理器，请不要展开迭代次数大于 4 的循环。


## 展开循环的可能开销如下：

展开过度或展开非常大的循环时，可能导致代码篇幅增加。如果展开后的循环不能再放入跟踪缓存 (TC)，这将有害无益。
展开循环体中包含分支的循环时，会增加对 BTB 容量的需求。如果展开后循环的迭代次数是 16 或更少，则分支预测应该能正确预测循环体中改变方向的分支。


## 编译器自动循环展开

可以使用如下编译选项自动循环展开：-funroll-loops。
一般的编译选项-O2，-O3中都会进行循环展开。

使用openmp可以指定循环展开几次。

	
	（1）告诉编译器不要展开循环
	/#pragma nounroll

	（2）告诉编译器循环展开的次数
	/#pragma unroll
	/#pragma unroll(n)

	（3）告诉编译器没有数据依赖
	/#pragma ivdep

	（4）告诉编译器不要把循环自动矢量化
	/#pragma novector

	（5）怎么样自动矢量化，哪些影响矢量化选择的因素可以忽略掉
	/#pragma vector
	{aligned|unaligned|always}

	（6）自动矢量化的代码中采用流式存储
	/#pragma vector nontemporal


但是一般编译器进行的都是保守的优化，故程序员最好手动展开2，4， 8, 16次，试试哪个效果最好。


## 引用：
1.http://scc.qibebt.cas.cn/docs/optimization/VTune(TM)%20User's%20Guide/mergedProjects/analyzer_ec/mergedProjects/reference_olh/Pentium4_HH/Advice4_HH/Loop_Unrolling.htm
